@page "/testtracker"
@using BlazorApp1.Models
@using BlazorApp1.Services
@inject DeadlockService DeadlockApi
@inject SteamService SteamApi
@rendermode InteractiveServer

<h3>Deadlock Hero Stats Tracker</h3>

<div class="mb-3">
    @* We change the placeholder because now it supports names too! *@
    <input @bind="SearchInput" class="form-control" placeholder="Enter Steam Name or ID (e.g. gabelogannewell)" />
    <button class="btn btn-primary mt-2" @onclick="FetchStats" disabled="@IsLoading">
        @if (IsLoading) { <span>Loading...</span> } else { <span>Fetch Stats</span> }
    </button>
</div>

@if (!string.IsNullOrEmpty(ErrorMessage))
{
    <div class="alert alert-danger">@ErrorMessage</div>
}

@if (FoundProfile != null)
{
    @* Mini Steam Profile Header *@
    <div class="card mb-3 bg-light">
        <div class="card-body d-flex align-items-center">
            <img src="@FoundProfile.AvatarUrl" class="rounded-circle me-3" style="width: 60px;" />
            <div>
                <h5 class="mb-0">@FoundProfile.PersonaName</h5>
                <small class="text-muted">ID: @FoundProfile.SteamId</small>
            </div>
        </div>
    </div>
}

@if (PlayerData != null)
{
    <h4>Stats</h4>
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Hero</th>
                <th>Matches</th>
                <th>Win Rate</th>
                <th>Time Played</th>
                <th>Last Played</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var hero in PlayerData.HeroStats.OrderByDescending(h => h.MatchesPlayed))
            {
                <tr>
                    <td>@hero.HeroName</td>
                    <td>@hero.MatchesPlayed</td>
                    <td style="color: @(hero.WinRate >= 50 ? "green" : "red")">
                        @hero.WinRate.ToString("F1")%
                    </td>
                    <td>@hero.TimePlayedSpan</td>
                    <td>@hero.LastPlayedDate</td>
                </tr>
            }
        </tbody>
    </table>
}

@code {
    private string? SearchInput; // Renamed from SteamId to reflect it can be a name
    private PlayerHeroSummary? PlayerData;
    private SteamPlayer? FoundProfile; // To store the Steam name/avatar
    private bool IsLoading = false;
    private string? ErrorMessage;

    private async Task FetchStats()
    {
        if (string.IsNullOrWhiteSpace(SearchInput)) return;

        IsLoading = true;
        ErrorMessage = null;
        PlayerData = null;
        FoundProfile = null;

        try 
        {
            string targetSteamId;

            // 1. Resolve the input to a 64-bit Steam ID
            if (long.TryParse(SearchInput, out _))
            {
                // User entered a numeric ID
                targetSteamId = SearchInput;
                FoundProfile = await SteamApi.GetPlayerSummary(targetSteamId);
            }
            else
            {
                // User entered a vanity name
                FoundProfile = await SteamApi.GetPlayerByVanityUrl(SearchInput);
                targetSteamId = FoundProfile?.SteamId ?? "";
            }

            // 2. If we have a valid ID, get the Deadlock stats
            if (!string.IsNullOrEmpty(targetSteamId))
            {
                PlayerData = await DeadlockApi.GetPlayerWinRates(targetSteamId);

                if (PlayerData == null)
                {
                    ErrorMessage = "Could not find Deadlock data for this player.";
                }
            }
            else
            {
                ErrorMessage = "Could not find that Steam account.";
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = "An error occurred while connecting to the APIs.";
            Console.WriteLine(ex.Message);
        }

        IsLoading = false;
    }
}